<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>VIB34D Holographic Engine - Refactored</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        /* VIB34D Refactored CSS */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #000;
            color: #fff;
            font-family: 'Orbitron', monospace;
            overflow: hidden;
            position: relative;
        }
        
        /* 5-Layer Holographic Canvas System */
        .holographic-layers {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            pointer-events: none;
        }
        
        .holographic-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: auto;
        }
        
        #background-canvas { z-index: 1; opacity: 0.6; mix-blend-mode: normal; }
        #shadow-canvas { z-index: 3; opacity: 0.4; mix-blend-mode: multiply; }
        #content-canvas { z-index: 5; opacity: 0.9; mix-blend-mode: screen; }
        #highlight-canvas { z-index: 7; opacity: 0.7; mix-blend-mode: overlay; }
        #accent-canvas { z-index: 15; opacity: 0.5; mix-blend-mode: color-dodge; }
        
        /* Control Panel */
        .control-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid #00ffff;
            border-radius: 10px;
            padding: 20px;
            min-width: 320px;
            max-height: 90vh;
            overflow-y: auto;
            z-index: 1000;
            backdrop-filter: blur(10px);
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        
        /* Collapsible Panel States */
        .control-panel.collapsed {
            transform: translateX(calc(100% - 50px));
            opacity: 0.8;
        }
        
        .control-panel.collapsed:hover {
            transform: translateX(calc(100% - 80px));
            opacity: 0.9;
        }
        
        /* Collapse Toggle Button */
        .collapse-toggle {
            position: absolute;
            left: -40px;
            top: 10px;
            width: 35px;
            height: 35px;
            background: rgba(0, 255, 255, 0.2);
            border: 1px solid #00ffff;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: #00ffff;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .collapse-toggle:hover {
            background: rgba(0, 255, 255, 0.4);
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
        }
        
        /* Hide control panel in preview mode */
        .preview-mode .control-panel {
            display: none !important;
        }
        
        /* Hide status in preview mode */
        .preview-mode .status {
            display: none !important;
        }
        
        .control-panel h2 {
            color: #00ffff;
            margin-bottom: 15px;
            text-align: center;
            font-size: 1.2rem;
            text-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 1px solid rgba(0, 255, 255, 0.3);
        }
        
        .tab-btn {
            flex: 1;
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            padding: 8px 5px;
            cursor: pointer;
            font-family: 'Orbitron', monospace;
            font-size: 0.7rem;
            transition: all 0.3s ease;
            border-bottom: 2px solid transparent;
        }
        
        .tab-btn.active {
            color: #00ffff;
            border-bottom-color: #00ffff;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Controls */
        .control-group {
            margin-bottom: 15px;
        }
        
        .control-label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.8);
        }
        
        .control-input {
            width: 100%;
            background: rgba(0, 255, 255, 0.1);
            border: 1px solid rgba(0, 255, 255, 0.3);
            border-radius: 5px;
            padding: 8px;
            color: #fff;
            font-family: 'Orbitron', monospace;
            font-size: 0.8rem;
        }
        
        .control-input:focus {
            outline: none;
            border-color: #00ffff;
            box-shadow: 0 0 5px rgba(0, 255, 255, 0.3);
        }
        
        .control-display {
            display: inline-block;
            float: right;
            color: #00ffff;
            font-weight: bold;
        }
        
        /* Buttons */
        .btn {
            background: rgba(0, 255, 255, 0.2);
            border: 1px solid #00ffff;
            color: #00ffff;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Orbitron', monospace;
            font-size: 0.8rem;
            transition: all 0.3s ease;
            margin: 2px;
        }
        
        .btn:hover {
            background: rgba(0, 255, 255, 0.3);
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.3);
        }
        
        .btn.active {
            background: rgba(0, 255, 255, 0.5);
        }
        
        /* Geometry Presets */
        .geometry-presets {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px;
            margin-bottom: 15px;
        }
        
        /* Variation Grid */
        .variation-controls {
            margin-bottom: 15px;
        }
        
        .variation-nav {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .variation-info {
            margin-bottom: 10px;
            padding: 10px;
            background: rgba(0, 255, 255, 0.1);
            border-radius: 5px;
            font-size: 0.8rem;
        }
        
        /* Status */
        .status {
            position: fixed;
            bottom: 20px;
            left: 20px;
            padding: 10px 20px;
            border-radius: 5px;
            font-family: 'Orbitron', monospace;
            font-size: 0.8rem;
            z-index: 1000;
            transition: all 0.3s ease;
        }
        
        .status.success {
            background: rgba(0, 255, 0, 0.2);
            border: 1px solid #00ff00;
            color: #00ff00;
        }
        
        .status.error {
            background: rgba(255, 0, 0, 0.2);
            border: 1px solid #ff0000;
            color: #ff0000;
        }
        
        .status.warning {
            background: rgba(255, 255, 0, 0.2);
            border: 1px solid #ffff00;
            color: #ffff00;
        }
        
        .status.info {
            background: rgba(0, 255, 255, 0.2);
            border: 1px solid #00ffff;
            color: #00ffff;
        }
        
        /* Gallery Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 2000;
        }
        
        .modal.active {
            display: block;
        }
        
        .modal-content {
            position: relative;
            margin: 2% auto;
            width: 95%;
            height: 95%;
            background: rgba(0, 0, 0, 0.95);
            border: 1px solid #00ffff;
            border-radius: 10px;
            overflow: hidden;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .control-panel {
                right: 10px;
                top: 10px;
                min-width: 280px;
            }
            
            .geometry-presets {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- 5-Layer Holographic Canvas System -->
    <div class="holographic-layers">
        <canvas id="background-canvas" class="holographic-canvas"></canvas>
        <canvas id="shadow-canvas" class="holographic-canvas"></canvas>
        <canvas id="content-canvas" class="holographic-canvas"></canvas>
        <canvas id="highlight-canvas" class="holographic-canvas"></canvas>
        <canvas id="accent-canvas" class="holographic-canvas"></canvas>
    </div>
    
    <!-- Active Holographic System Layers -->
    <div class="holographic-layers active-holo" style="display: none;">
        <canvas id="holo-background-canvas" class="holographic-canvas"></canvas>
        <canvas id="holo-shadow-canvas" class="holographic-canvas"></canvas>
        <canvas id="holo-content-canvas" class="holographic-canvas"></canvas>
        <canvas id="holo-highlight-canvas" class="holographic-canvas"></canvas>
        <canvas id="holo-accent-canvas" class="holographic-canvas"></canvas>
    </div>
    
    <!-- Control Panel -->
    <div class="control-panel" id="controlPanel">
        <div class="collapse-toggle" id="collapseToggle" onclick="toggleControlPanel()">‹</div>
        <h2>VIB34D Holographic Engine</h2>\n\n        <!-- Enhanced Control Header -->\n        <div class=\"control-header\" style=\"background: linear-gradient(145deg, rgba(0, 255, 255, 0.05), rgba(0, 255, 255, 0.02)); border: 1px solid rgba(0, 255, 255, 0.2); border-radius: 8px; padding: 12px; margin: 10px 0 15px 0; display: flex; justify-content: space-between; align-items: center; gap: 10px;\">\n            <div class=\"system-status\" style=\"display: flex; flex-direction: column; gap: 4px;\">\n                <span id=\"currentSystemIndicator\" style=\"font-size: 0.8rem; font-weight: bold; color: #00ffff;\">🔷 VIB34D System</span>\n                <span id=\"parameterSyncStatus\" style=\"font-size: 0.6rem; color: rgba(0, 255, 0, 0.8); text-transform: uppercase; letter-spacing: 1px;\">Synced</span>\n            </div>\n            <div class=\"quick-actions\" style=\"display: flex; gap: 6px;\">\n                <button class=\"quick-btn\" onclick=\"quickRandomize()\" title=\"Quick randomize visual parameters\" style=\"background: rgba(0, 255, 255, 0.15); border: 1px solid rgba(0, 255, 255, 0.3); color: #00ffff; padding: 6px 10px; border-radius: 5px; cursor: pointer; font-family: 'Orbitron', monospace; font-size: 0.6rem; font-weight: bold; transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 0.5px;\">⚡ Quick</button>\n                <button class=\"quick-btn\" onclick=\"randomizeParameters()\" title=\"Full randomization\" style=\"background: rgba(0, 255, 255, 0.15); border: 1px solid rgba(0, 255, 255, 0.3); color: #00ffff; padding: 6px 10px; border-radius: 5px; cursor: pointer; font-family: 'Orbitron', monospace; font-size: 0.6rem; font-weight: bold; transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 0.5px;\">🎲 Random</button>\n                <button class=\"quick-btn\" onclick=\"switchToSystem(unifiedParameters.systemType === 'VIB34D' ? 'Holographic' : 'VIB34D')\" title=\"Switch between systems\" style=\"background: rgba(0, 255, 255, 0.15); border: 1px solid rgba(0, 255, 255, 0.3); color: #00ffff; padding: 6px 10px; border-radius: 5px; cursor: pointer; font-family: 'Orbitron', monospace; font-size: 0.6rem; font-weight: bold; transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 0.5px;\">🔄 Switch</button>\n            </div>\n        </div>
        
        <!-- Tabs -->
        <div class="tabs">
            <button class="tab-btn active" data-tab="variations" title="VIB34D Polytopal Variations">🔷 VIB34D</button>
            <button class="tab-btn" data-tab="polytopal" title="4D Mathematics Control">🧮 4D Math</button>
            <button class="tab-btn" data-tab="holographic" title="Holographic Parameters">🌀 Holo Params</button>
            <button class="tab-btn" data-tab="holograms" title="Active Holographic System">✨ Live Holo</button>
            <button class="tab-btn" data-tab="export" title="Export & Import System">📤 Export</button>
        </div>
        
        <!-- Variations Tab -->
        <div class="tab-content active" id="variations-tab">
            <div class="variation-controls">
                <div class="variation-nav">
                    <button class="btn" onclick="engine.previousVariation()">← Prev</button>
                    <button class="btn" onclick="engine.randomVariation()">Random</button>
                    <button class="btn" onclick="engine.nextVariation()">Next →</button>
                </div>
                
                <div class="control-group">
                    <label class="control-label">
                        Variation <span class="control-display" id="currentVariationDisplay">1</span>
                    </label>
                    <input type="range" id="variationSlider" class="control-input" min="0" max="99" value="0">
                </div>
                
                <div class="variation-info">
                    <div id="currentVariation">1 - TETRAHEDRON LATTICE 1</div>
                </div>
                
                <div class="variation-nav">
                    <button class="btn" onclick="engine.saveAsCustomVariation()">Save Custom</button>
                    <button class="btn" onclick="engine.openGalleryView()">Gallery</button>
                </div>
            </div>
            
            <div class="geometry-presets">
                <button class="btn active" data-geometry="0">Tetrahedron</button>
                <button class="btn" data-geometry="1">Hypercube</button>
                <button class="btn" data-geometry="2">Sphere</button>
                <button class="btn" data-geometry="3">Torus</button>
                <button class="btn" data-geometry="4">Klein Bottle</button>
                <button class="btn" data-geometry="5">Fractal</button>
                <button class="btn" data-geometry="6">Wave</button>
                <button class="btn" data-geometry="7">Crystal</button>
            </div>
        </div>
        
        <!-- 4D Math Tab -->
        <div class="tab-content" id="polytopal-tab">
            <div class="control-group">
                <label class="control-label">
                    4D Rotation XW <span class="control-display" id="rot4dXWDisplay">0.00</span>
                </label>
                <input type="range" id="rot4dXW" class="control-input" min="-2" max="2" step="0.01" value="0">
            </div>
            
            <div class="control-group">
                <label class="control-label">
                    4D Rotation YW <span class="control-display" id="rot4dYWDisplay">0.00</span>
                </label>
                <input type="range" id="rot4dYW" class="control-input" min="-2" max="2" step="0.01" value="0">
            </div>
            
            <div class="control-group">
                <label class="control-label">
                    4D Rotation ZW <span class="control-display" id="rot4dZWDisplay">0.00</span>
                </label>
                <input type="range" id="rot4dZW" class="control-input" min="-2" max="2" step="0.01" value="0">
            </div>
            
            <div class="control-group">
                <label class="control-label">
                    Dimension <span class="control-display" id="dimensionDisplay">3.50</span>
                </label>
                <input type="range" id="dimension" class="control-input" min="3" max="4.5" step="0.01" value="3.5">
            </div>
            
            <div style="text-align: center; margin-top: 15px;">
                <button class="btn" onclick="engine.randomizeAll()">Randomize All</button>
                <button class="btn" onclick="engine.resetToDefaults()">Reset</button>
            </div>
            
            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(0,255,255,0.3);">
                <h4 style="color: #00ffff; margin-bottom: 10px; font-size: 0.9rem;">⚙️ System Controls</h4>
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <button class="btn" id="vib34dAudioToggle" onclick="toggleVIB34DAudio()" style="flex: 1; font-size: 0.7rem;">🎵 Audio Off</button>
                    <button class="btn" onclick="saveVIB34DToPortfolio()" style="flex: 1; font-size: 0.7rem; background: rgba(255,100,255,0.3); border-color: #ff64ff; color: #ff64ff;">💾 Save</button>
                </div>
                <button class="btn" onclick="openUnifiedGallery()" style="width: 100%; font-size: 0.7rem; background: rgba(0,255,100,0.3); border-color: #00ff64; color: #00ff64;">🖼️ View Portfolio</button>
            </div>
        </div>
        
        <!-- Holographic Tab -->
        <div class="tab-content" id="holographic-tab">
            <div class="control-group">
                <label class="control-label">
                    Grid Density <span class="control-display" id="gridDensityDisplay">15.0</span>
                </label>
                <input type="range" id="gridDensity" class="control-input" min="4" max="30" step="0.1" value="15">
            </div>
            
            <div class="control-group">
                <label class="control-label">
                    Morph Factor <span class="control-display" id="morphFactorDisplay">1.00</span>
                </label>
                <input type="range" id="morphFactor" class="control-input" min="0" max="2" step="0.01" value="1">
            </div>
            
            <div class="control-group">
                <label class="control-label">
                    Chaos <span class="control-display" id="chaosDisplay">0.20</span>
                </label>
                <input type="range" id="chaos" class="control-input" min="0" max="1" step="0.01" value="0.2">
            </div>
            
            <div class="control-group">
                <label class="control-label">
                    Speed <span class="control-display" id="speedDisplay">1.00</span>
                </label>
                <input type="range" id="speed" class="control-input" min="0.1" max="3" step="0.01" value="1">
            </div>
            
            <div class="control-group">
                <label class="control-label">
                    Hue <span class="control-display" id="hueDisplay">200°</span>
                </label>
                <input type="range" id="hue" class="control-input" min="0" max="360" step="1" value="200">
            </div>
            
            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(0,255,255,0.3);">
                <h4 style="color: #00ffff; margin-bottom: 10px; font-size: 0.9rem;">⚙️ System Controls</h4>
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <button class="btn" id="vib34dAudioToggle2" onclick="toggleVIB34DAudio()" style="flex: 1; font-size: 0.7rem;">🎵 Audio Off</button>
                    <button class="btn" onclick="saveVIB34DToPortfolio()" style="flex: 1; font-size: 0.7rem; background: rgba(255,100,255,0.3); border-color: #ff64ff; color: #ff64ff;">💾 Save</button>
                </div>
                <button class="btn" onclick="openUnifiedGallery()" style="width: 100%; font-size: 0.7rem; background: rgba(0,255,100,0.3); border-color: #00ff64; color: #00ff64;">🖼️ View Portfolio</button>
            </div>
        </div>
        
        <!-- Active Holograms Tab -->
        <div class="tab-content" id="holograms-tab">
            <div class="control-group">
                <h3 style="color: #00ffff; margin-bottom: 15px;">Active Holographic System</h3>
                <div style="margin-bottom: 15px;">
                    <button class="btn" id="toggle-holo" onclick="toggleHolographicSystem()">Activate Holograms</button>
                </div>
            </div>
            
            <div class="variation-controls">
                <div class="variation-nav">
                    <button class="btn" onclick="holoSystem.previousVariant()">← Prev</button>
                    <button class="btn" onclick="holoSystem.randomVariant()">Random</button>
                    <button class="btn" onclick="holoSystem.nextVariant()">Next →</button>
                </div>
                
                <div class="control-group">
                    <label class="control-label">
                        Hologram Variant <span class="control-display" id="holoVariationDisplay">1</span>
                    </label>
                    <input type="range" id="holoVariationSlider" class="control-input" min="0" max="29" value="0" 
                           onchange="holoSystem.setVariant(parseInt(this.value)); updateHoloDisplay();">
                </div>
                
                <div class="variation-info">
                    <div id="currentHoloVariation">1 - TETRAHEDRON LATTICE</div>
                </div>
            </div>
            
            <div class="geometry-presets">
                <button class="btn holo-geom active" data-holo-geometry="0" onclick="setHoloGeometry(0)">Tetrahedron</button>
                <button class="btn holo-geom" data-holo-geometry="4" onclick="setHoloGeometry(4)">Hypercube</button>
                <button class="btn holo-geom" data-holo-geometry="8" onclick="setHoloGeometry(8)">Sphere</button>
                <button class="btn holo-geom" data-holo-geometry="12" onclick="setHoloGeometry(12)">Torus</button>
                <button class="btn holo-geom" data-holo-geometry="16" onclick="setHoloGeometry(16)">Klein Bottle</button>
                <button class="btn holo-geom" data-holo-geometry="20" onclick="setHoloGeometry(20)">Fractal</button>
                <button class="btn holo-geom" data-holo-geometry="23" onclick="setHoloGeometry(23)">Wave</button>
                <button class="btn holo-geom" data-holo-geometry="26" onclick="setHoloGeometry(26)">Crystal</button>
            </div>
            
            <!-- HOLOGRAPHIC PARAMETER CONTROLS -->
            <div style="margin-top: 20px; border-top: 1px solid rgba(0,255,255,0.3); padding-top: 15px;">
                <h4 style="color: #00ffff; margin-bottom: 10px;">🎛️ Holographic Parameters</h4>
                
                <div class="control-group">
                    <label class="control-label">
                        Density <span class="control-display" id="holoDensityDisplay">1.00</span>
                    </label>
                    <input type="range" id="holoDensity" class="control-input" min="0.5" max="3.0" step="0.1" value="1.0" 
                           oninput="updateHoloParameter('density', this.value)">
                </div>
                
                <div class="control-group">
                    <label class="control-label">
                        Speed <span class="control-display" id="holoSpeedDisplay">0.50</span>
                    </label>
                    <input type="range" id="holoSpeed" class="control-input" min="0.1" max="2.0" step="0.1" value="0.5" 
                           oninput="updateHoloParameter('speed', this.value)">
                </div>
                
                <div class="control-group">
                    <label class="control-label">
                        Chaos <span class="control-display" id="holoChaosDisplay">0.00</span>
                    </label>
                    <input type="range" id="holoChaos" class="control-input" min="0" max="1" step="0.05" value="0" 
                           oninput="updateHoloParameter('chaos', this.value)">
                </div>
                
                <div class="control-group">
                    <label class="control-label">
                        Morph <span class="control-display" id="holoMorphDisplay">0.00</span>
                    </label>
                    <input type="range" id="holoMorph" class="control-input" min="0" max="1" step="0.05" value="0" 
                           oninput="updateHoloParameter('morph', this.value)">
                </div>
                
                <div class="control-group">
                    <label class="control-label">
                        Hue <span class="control-display" id="holoHueDisplay">0°</span>
                    </label>
                    <input type="range" id="holoHue" class="control-input" min="0" max="360" step="5" value="0" 
                           oninput="updateHoloParameter('hue', this.value)">
                </div>
                
                <div class="control-group">
                    <label class="control-label">
                        Saturation <span class="control-display" id="holoSaturationDisplay">0.80</span>
                    </label>
                    <input type="range" id="holoSaturation" class="control-input" min="0" max="1" step="0.05" value="0.8" 
                           oninput="updateHoloParameter('saturation', this.value)">
                </div>
                
                <div class="control-group">
                    <label class="control-label">
                        Intensity <span class="control-display" id="holoIntensityDisplay">0.50</span>
                    </label>
                    <input type="range" id="holoIntensity" class="control-input" min="0.1" max="1" step="0.05" value="0.5" 
                           oninput="updateHoloParameter('intensity', this.value)">
                </div>
                
                <div style="margin-top: 15px;">
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <button class="btn" id="holoAudioToggle" onclick="toggleHolographicAudio()" style="flex: 1; font-size: 0.7rem;">🎵 Audio On</button>
                        <button class="btn" onclick="saveHologramToPortfolio()" style="flex: 1; font-size: 0.7rem; background: rgba(255,100,255,0.3); border-color: #ff64ff; color: #ff64ff;">💾 Save</button>
                    </div>
                    <button class="btn" onclick="openUnifiedGallery()" style="width: 100%; font-size: 0.7rem; background: rgba(0,255,100,0.3); border-color: #00ff64; color: #00ff64;">🖼️ View Portfolio</button>
                </div>
            </div>
            
            <div style="margin-top: 20px; font-size: 0.8rem; color: rgba(255,255,255,0.7);">
                <p>✨ Multi-layer holographic effects</p>
                <p>🎨 Audio-reactive visualizations</p>
                <p>🔮 30 base variants + custom portfolio</p>
                <p>🖱️ Mouse, touch, scroll, audio interactions</p>
            </div>
        </div>
        
        <!-- Export Tab -->
        <div class="tab-content" id="export-tab">
            <div class="control-group">
                <h3 style="color: #00ffff; margin-bottom: 10px;">Export</h3>
                <button class="btn" onclick="engine.exportJSON()" style="width: 100%; margin-bottom: 5px;">Export JSON Config</button>
                <button class="btn" onclick="engine.exportCSS()" style="width: 100%; margin-bottom: 5px;">Export CSS Theme</button>
                <button class="btn" onclick="engine.exportHTML()" style="width: 100%; margin-bottom: 5px;">Export HTML Page</button>
                <button class="btn" onclick="engine.exportPNG()" style="width: 100%; margin-bottom: 15px;">Export PNG Image</button>
            </div>
            
            <div class="control-group">
                <h3 style="color: #00ffff; margin-bottom: 10px;">Import</h3>
                <button class="btn" onclick="engine.importJSON()" style="width: 100%; margin-bottom: 5px;">Import JSON Config</button>
                <button class="btn" onclick="engine.importFolder()" style="width: 100%;">Import Folder</button>
            </div>
        </div>
    </div>
    
    <!-- Status Display -->
    <div id="status" class="status"></div>
    
    <!-- Load ES6 Modules -->
    <script type="module">
        // Check for preview mode
        const urlParams = new URLSearchParams(window.location.search);
        const isPreviewMode = urlParams.get('preview') === 'true' || urlParams.get('hideui') === 'true';
        
        if (isPreviewMode) {
            document.body.classList.add('preview-mode');
            console.log('🔍 Preview mode activated - UI hidden');
            
            // Auto-activate holograms if requested
            if (urlParams.get('holograms') === 'true') {
                // Wait for system to load, then activate holograms
                setTimeout(() => {
                    if (window.realHoloSystem) {
                        window.realHoloSystem.setActive(true);
                        console.log('🌌 Auto-activated holograms in preview mode');
                        
                        // Load URL parameters if provided
                        const density = urlParams.get('density');
                        const speed = urlParams.get('speed');
                        const chaos = urlParams.get('chaos');
                        const morph = urlParams.get('morph');
                        const hue = urlParams.get('hue');
                        const saturation = urlParams.get('saturation');
                        const intensity = urlParams.get('intensity');
                        const geometry = urlParams.get('geometry');
                        
                        if (geometry !== null) {
                            window.realHoloSystem.setVariant(parseInt(geometry));
                        }
                        
                        // Apply parameters
                        if (density !== null) updateHoloParameter('density', parseFloat(density));
                        if (speed !== null) updateHoloParameter('speed', parseFloat(speed));
                        if (chaos !== null) updateHoloParameter('chaos', parseFloat(chaos));
                        if (morph !== null) updateHoloParameter('morph', parseFloat(morph));
                        if (hue !== null) updateHoloParameter('hue', parseFloat(hue));
                        if (saturation !== null) updateHoloParameter('saturation', parseFloat(saturation));
                        if (intensity !== null) updateHoloParameter('intensity', parseFloat(intensity));
                    }
                }, 2000); // Wait 2 seconds for system to fully load
            }
        }
        
        // Add cache busting to prevent old file conflicts
        const cacheBuster = '?v=' + Date.now();
        
        // Load main VIB34D Engine
        import('./src/core/Engine.js' + cacheBuster).then(module => {
            const { VIB34DIntegratedEngine } = module;
            
            // Initialize VIB34D Engine
            window.engine = new VIB34DIntegratedEngine();
            
            console.log('🌌 VIB34D Holographic Engine - Refactored Version Loaded');
            console.log('✅ 5-Layer Holographic Rendering Active');
            console.log('🔮 100 Geometric Variations Available');
            console.log('🧮 4D Polytopal Mathematics Ready');
            console.log('🎮 Interactive Controls Enabled');
        }).catch(error => {
            console.error('❌ Failed to load VIB34D Engine:', error);
            document.body.innerHTML += '<div style="color: red; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: black; padding: 20px; border: 1px solid red;">VIB34D Loading Error: ' + error.message + '</div>';
        });
        
        // Load REAL Holographic System for Active Holograms tab ONLY
        import('./src/holograms/RealHolographicSystem.js' + cacheBuster).then(module => {
            const { RealHolographicSystem } = module;
            
            // Initialize REAL Holographic System for the Active Holograms tab
            // This uses the holo-* canvas elements, NOT the regular ones
            window.realHoloSystem = new RealHolographicSystem();
            
            console.log('✨ REAL Active Holographic System Loaded for Active Holograms tab');
            console.log('🔮 30 VIB3 Elaborate Holographic Variants with Complex Shaders');
            console.log('🎨 Klein Bottles, Fractals, Tetrahedrons, Hypercubes');
            console.log('🌀 RGB Glitch, Moiré Patterns, 4D Mathematics');
            console.log('🖱️ FULL INTERACTIONS: Mouse, Click, Touch, Scroll, Audio');
            console.log('🎵 Audio Reactive + Mouse Reactive + Touch Morphing + Scroll Parallax');
            console.log('📺 Uses holo-* canvas layers separate from VIB34D system');
        }).catch(error => {
            console.error('❌ Failed to load REAL Holographic System:', error);
        });
        
        // Collapsible Control Panel
        window.toggleControlPanel = function() {
            const panel = document.getElementById('controlPanel');
            const toggle = document.getElementById('collapseToggle');
            
            panel.classList.toggle('collapsed');
            
            if (panel.classList.contains('collapsed')) {
                toggle.textContent = '›';
                toggle.title = 'Expand Control Panel';
                console.log('🔽 Control panel collapsed');
            } else {
                toggle.textContent = '‹';
                toggle.title = 'Collapse Control Panel';
                console.log('🔼 Control panel expanded');
            }
        };
        
        // Keyboard shortcut for panel collapse
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Tab' && e.ctrlKey) {
                e.preventDefault();
                toggleControlPanel();
            }
        });
        
        // Global functions for REAL Active Holographic System
        window.toggleHolographicSystem = function() {
            const button = document.getElementById('toggle-holo');
            const isActive = button.textContent === 'Deactivate Holograms';
            
            if (isActive) {
                // Deactivate REAL holographic system
                realHoloSystem.setActive(false);
                button.textContent = 'Activate Holograms';
                button.classList.remove('active');
                console.log('🔴 REAL Active Holograms DEACTIVATED - VIB34D system restored');
            } else {
                // Activate REAL holographic system with ALL interactions
                realHoloSystem.setActive(true);
                button.textContent = 'Deactivate Holograms';
                button.classList.add('active');
                console.log('🟢 REAL Active Holograms ACTIVATED with FULL interactions (mouse, click, touch, scroll, audio)');
            }
            
            updateHoloDisplay();
        };
        
        window.updateHoloDisplay = function() {
            if (!window.realHoloSystem) return;
            
            const variantInfo = realHoloSystem.getCurrentVariantInfo();
            if (!variantInfo) return;
            
            const currentVariant = variantInfo.variant;
            const variantName = variantInfo.name;
            
            document.getElementById('holoVariationDisplay').textContent = currentVariant + 1;
            document.getElementById('currentHoloVariation').textContent = `${currentVariant + 1} - ${variantName}`;
            document.getElementById('holoVariationSlider').value = currentVariant;
            
            // Update geometry buttons
            document.querySelectorAll('.holo-geom').forEach(btn => {
                btn.classList.remove('active');
            });
            
            const activeGeometry = Math.floor(currentVariant / 4) * 4;
            const activeBtn = document.querySelector(`[data-holo-geometry="${activeGeometry}"]`);
            if (activeBtn) {
                activeBtn.classList.add('active');
            }
            
            // Sync parameter sliders to match current variant
            setTimeout(() => {
                syncHolographicSliders();
            }, 100); // Small delay to ensure variant parameters are updated
        };
        
        window.setHoloGeometry = function(startVariant) {
            if (window.realHoloSystem) {
                realHoloSystem.updateVariant(startVariant);
                updateHoloDisplay();
            }
        };
        
        // Create holoSystem interface that points to realHoloSystem
        window.holoSystem = {
            setVariant: function(variant) {
                if (window.realHoloSystem) {
                    realHoloSystem.setVariant(variant);
                    updateHoloDisplay();
                }
            },
            nextVariant: function() {
                if (window.realHoloSystem) {
                    realHoloSystem.nextVariant();
                    updateHoloDisplay();
                }
            },
            previousVariant: function() {
                if (window.realHoloSystem) {
                    realHoloSystem.previousVariant();
                    updateHoloDisplay();
                }
            },
            randomVariant: function() {
                if (window.realHoloSystem) {
                    realHoloSystem.randomVariant();
                    updateHoloDisplay();
                }
            },
            get currentVariant() {
                return window.realHoloSystem ? realHoloSystem.currentVariant : 0;
            }
        };
        
        // HOLOGRAPHIC PARAMETER CONTROLS
        window.updateHoloParameter = function(paramName, value) {
            if (!window.realHoloSystem || !realHoloSystem.isActive) return;
            
            const numValue = parseFloat(value);
            
            // Update display
            const displayId = `holo${paramName.charAt(0).toUpperCase() + paramName.slice(1)}Display`;
            const displayElement = document.getElementById(displayId);
            if (displayElement) {
                if (paramName === 'hue') {
                    displayElement.textContent = Math.round(numValue) + '°';
                } else {
                    displayElement.textContent = numValue.toFixed(2);
                }
            }
            
            // Update all holographic visualizers with new parameter
            realHoloSystem.visualizers.forEach(visualizer => {
                if (visualizer.variantParams) {
                    visualizer.variantParams[paramName] = numValue;
                    // Regenerate role parameters with updated variant params
                    visualizer.roleParams = visualizer.generateRoleParams(visualizer.role);
                }
            });
            
            console.log(`🎛️ Updated holographic ${paramName}: ${numValue}`);
        };
        
        window.getCurrentHolographicParameters = function() {
            if (!window.realHoloSystem || realHoloSystem.visualizers.length === 0) return null;
            
            const contentVisualizer = realHoloSystem.visualizers.find(v => v.role === 'content');
            if (!contentVisualizer || !contentVisualizer.variantParams) return null;
            
            return {
                geometryType: contentVisualizer.variantParams.geometryType || 0,
                density: contentVisualizer.variantParams.density || 1.0,
                speed: contentVisualizer.variantParams.speed || 0.5,
                chaos: contentVisualizer.variantParams.chaos || 0.0,
                morph: contentVisualizer.variantParams.morph || 0.0,
                hue: contentVisualizer.variantParams.hue || 0,
                saturation: contentVisualizer.variantParams.saturation || 0.8,
                intensity: contentVisualizer.variantParams.intensity || 0.5
            };
        };
        
        window.saveHologramToPortfolio = function() {
            const params = getCurrentHolographicParameters();
            if (!params) {
                alert('❌ No holographic parameters to save. Activate holograms first!');
                return;
            }
            
            // Get current variant info for naming
            const variantInfo = realHoloSystem.getCurrentVariantInfo();
            const geometryNames = ['TETRAHEDRON', 'HYPERCUBE', 'SPHERE', 'TORUS', 'KLEIN BOTTLE', 'FRACTAL', 'WAVE', 'CRYSTAL'];
            const baseName = geometryNames[params.geometryType] || 'UNKNOWN';
            
            // Generate unique name
            const timestamp = new Date().toLocaleTimeString().replace(/:/g, '');
            const customName = `HOLO ${baseName} ${timestamp}`;
            
            // Convert to unified format
            const unifiedParams = {
                systemType: 'Holographic',
                geometryType: params.geometryType,
                density: params.density,
                speed: params.speed,
                chaos: params.chaos,
                morph: params.morph,
                hue: params.hue,
                saturation: params.saturation,
                intensity: params.intensity,
                audioEnabled: realHoloSystem.audioEnabled || false
            };
            
            // Create unified variation object
            const unifiedVariation = {
                name: customName,
                type: 'Holographic',
                params: unifiedParams,
                created: new Date().toISOString(),
                isCustom: true,
                shareUrl: generateShareURL(unifiedParams)
            };
            
            saveToUnifiedPortfolio(unifiedVariation);
        };
        
        window.openHologramGallery = function() {
            // Create a hologram gallery URL (we'll create this file)
            window.open('./hologram-gallery.html', '_blank');
        };
        
        // VIB34D Audio Toggle
        window.toggleVIB34DAudio = function() {
            if (!window.engine) return;
            
            const button1 = document.getElementById('vib34dAudioToggle');
            const button2 = document.getElementById('vib34dAudioToggle2');
            
            if (engine.audioEnabled) {
                // Disable audio
                engine.audioEnabled = false;
                if (button1) {
                    button1.textContent = '🎵 Audio Off';
                    button1.style.background = 'rgba(255,0,77,0.3)';
                    button1.style.borderColor = '#ff004d';
                    button1.style.color = '#ff004d';
                }
                if (button2) {
                    button2.textContent = '🎵 Audio Off';
                    button2.style.background = 'rgba(255,0,77,0.3)';
                    button2.style.borderColor = '#ff004d';
                    button2.style.color = '#ff004d';
                }
                console.log('🔇 VIB34D audio disabled');
            } else {
                // Enable audio
                engine.initAudio().then(() => {
                    if (button1) {
                        button1.textContent = '🎵 Audio On';
                        button1.style.background = 'rgba(0,255,77,0.3)';
                        button1.style.borderColor = '#00ff4d';
                        button1.style.color = '#00ff4d';
                    }
                    if (button2) {
                        button2.textContent = '🎵 Audio On';
                        button2.style.background = 'rgba(0,255,77,0.3)';
                        button2.style.borderColor = '#00ff4d';
                        button2.style.color = '#00ff4d';
                    }
                    console.log('🔊 VIB34D audio enabled');
                }).catch(e => {
                    console.error('VIB34D audio failed:', e);
                });
            }
        };
        
        // Holographic Audio Toggle
        window.toggleHolographicAudio = function() {
            if (!window.realHoloSystem) return;
            
            const button = document.getElementById('holoAudioToggle');
            
            if (realHoloSystem.audioEnabled) {
                // Disable audio
                realHoloSystem.audioEnabled = false;
                if (button) {
                    button.textContent = '🎵 Audio Off';
                    button.style.background = 'rgba(255,0,77,0.3)';
                    button.style.borderColor = '#ff004d';
                    button.style.color = '#ff004d';
                }
                console.log('🔇 Holographic audio disabled');
            } else {
                // Enable audio
                realHoloSystem.initAudio().then(() => {
                    if (button) {
                        button.textContent = '🎵 Audio On';
                        button.style.background = 'rgba(0,255,77,0.3)';
                        button.style.borderColor = '#00ff4d';
                        button.style.color = '#00ff4d';
                    }
                    console.log('🔊 Holographic audio enabled');
                }).catch(e => {
                    console.error('Holographic audio failed:', e);
                });
            }
        };
        
        // Save VIB34D state to unified portfolio
        window.saveVIB34DToPortfolio = function() {
            if (!window.engine) {
                alert('❌ VIB34D system not loaded yet.');
                return;
            }
            
            // Get current VIB34D state
            const currentVariation = engine.currentVariant || 0;
            const variationName = engine.variantNames ? engine.variantNames[currentVariation] : `Variation ${currentVariation + 1}`;
            
            // Collect all current parameters
            const params = {
                systemType: 'VIB34D',
                variation: currentVariation,
                geometryType: Math.floor(currentVariation / 12.5), // Approximate geometry type
                // Get parameter values from UI
                rot4dXW: parseFloat(document.getElementById('rot4dXW')?.value || 0),
                rot4dYW: parseFloat(document.getElementById('rot4dYW')?.value || 0),
                rot4dZW: parseFloat(document.getElementById('rot4dZW')?.value || 0),
                dimension: parseFloat(document.getElementById('dimension')?.value || 3.5),
                gridDensity: parseFloat(document.getElementById('gridDensity')?.value || 15),
                morphFactor: parseFloat(document.getElementById('morphFactor')?.value || 1),
                chaos: parseFloat(document.getElementById('chaos')?.value || 0.2),
                speed: parseFloat(document.getElementById('speed')?.value || 1),
                hue: parseFloat(document.getElementById('hue')?.value || 200),
                audioEnabled: engine.audioEnabled || false
            };
            
            // Generate unique name
            const timestamp = new Date().toLocaleTimeString().replace(/:/g, '');
            const customName = `VIB34D ${variationName} ${timestamp}`;
            
            // Create unified variation object
            const unifiedVariation = {
                name: customName,
                type: 'VIB34D',
                params: params,
                created: new Date().toISOString(),
                isCustom: true,
                shareUrl: generateShareURL(params)
            };
            
            saveToUnifiedPortfolio(unifiedVariation);
        };
        
        // Generate shareable URL for any variation
        window.generateShareURL = function(params) {
            const baseUrl = window.location.origin + window.location.pathname;
            const urlParams = new URLSearchParams();
            
            if (params.systemType === 'VIB34D') {
                urlParams.set('system', 'vib34d');
                urlParams.set('variation', params.variation);
                if (params.rot4dXW !== 0) urlParams.set('rotXW', params.rot4dXW);
                if (params.rot4dYW !== 0) urlParams.set('rotYW', params.rot4dYW);
                if (params.rot4dZW !== 0) urlParams.set('rotZW', params.rot4dZW);
                if (params.dimension !== 3.5) urlParams.set('dimension', params.dimension);
                if (params.gridDensity !== 15) urlParams.set('density', params.gridDensity);
                if (params.morphFactor !== 1) urlParams.set('morph', params.morphFactor);
                if (params.chaos !== 0.2) urlParams.set('chaos', params.chaos);
                if (params.speed !== 1) urlParams.set('speed', params.speed);
                if (params.hue !== 200) urlParams.set('hue', params.hue);
                if (params.audioEnabled) urlParams.set('audio', 'true');
            } else if (params.systemType === 'Holographic') {
                urlParams.set('system', 'holograms');
                urlParams.set('holograms', 'true');
                if (params.geometryType !== undefined) urlParams.set('geometry', params.geometryType);
                if (params.density !== 1.0) urlParams.set('density', params.density);
                if (params.speed !== 0.5) urlParams.set('speed', params.speed);
                if (params.chaos !== 0.0) urlParams.set('chaos', params.chaos);
                if (params.morph !== 0.0) urlParams.set('morph', params.morph);
                if (params.hue !== 0) urlParams.set('hue', params.hue);
                if (params.saturation !== 0.8) urlParams.set('saturation', params.saturation);
                if (params.intensity !== 0.5) urlParams.set('intensity', params.intensity);
                if (params.audioEnabled) urlParams.set('audio', 'true');
            }
            
            return baseUrl + '?' + urlParams.toString();
        };
        
        // Save to unified portfolio system
        window.saveToUnifiedPortfolio = function(variation) {
            // Load existing portfolio
            let portfolio = [];
            try {
                const stored = localStorage.getItem('unifiedHolographicPortfolio');
                if (stored) {
                    const data = JSON.parse(stored);
                    portfolio = data.variations || [];
                }
            } catch (e) {
                console.error('Failed to load portfolio:', e);
            }
            
            // Add new variation
            portfolio.push(variation);
            
            // Save back to localStorage
            try {
                localStorage.setItem('unifiedHolographicPortfolio', JSON.stringify({
                    variations: portfolio,
                    timestamp: Date.now()
                }));
                
                console.log('💾 Saved to unified portfolio:', variation.name);
                alert(`✅ Saved "${variation.name}" to portfolio!\\n\\nTotal saved: ${portfolio.length} variations\\n\\nShare URL: ${variation.shareUrl}`);
            } catch (e) {
                console.error('Failed to save variation:', e);
                alert('❌ Failed to save to portfolio. Storage may be full.');
            }
        };
        
        // Open unified gallery
        window.openUnifiedGallery = function() {
            window.open('./unified-gallery.html', '_blank');
        };
        
        // ================================
        // UNIFIED PARAMETER SYSTEM
        // ================================
        
        // Global parameter state shared across all systems
        window.unifiedParameters = {
            // Visual parameters (shared)
            density: 1.5,
            speed: 0.8,
            chaos: 0.3,
            morph: 0.5,
            hue: 200,
            saturation: 0.8,
            intensity: 0.6,
            
            // System-specific
            systemType: 'VIB34D', // 'VIB34D' or 'Holographic'
            variation: 0,
            geometryType: 0,
            
            // 4D Math (VIB34D only)
            rot4dXW: 0,
            rot4dYW: 0,
            rot4dZW: 0,
            dimension: 3.5,
            
            // Audio
            audioEnabled: false
        };
        
        // RANDOMIZATION SYSTEM
        window.randomizeParameters = function(systemType = null) {
            const targetSystem = systemType || unifiedParameters.systemType;
            
            console.log(`🎲 Randomizing parameters for ${targetSystem} system`);
            
            // Randomize shared visual parameters
            const newParams = {
                density: 0.5 + Math.random() * 2.5,      // 0.5 - 3.0
                speed: 0.1 + Math.random() * 1.9,        // 0.1 - 2.0
                chaos: Math.random(),                     // 0.0 - 1.0
                morph: Math.random(),                     // 0.0 - 1.0
                hue: Math.floor(Math.random() * 360),     // 0 - 360
                saturation: 0.3 + Math.random() * 0.7,   // 0.3 - 1.0
                intensity: 0.2 + Math.random() * 0.8     // 0.2 - 1.0
            };
            
            // System-specific randomization
            if (targetSystem === 'VIB34D') {
                newParams.variation = Math.floor(Math.random() * 100);
                newParams.rot4dXW = (Math.random() - 0.5) * 4;  // -2 to +2
                newParams.rot4dYW = (Math.random() - 0.5) * 4;
                newParams.rot4dZW = (Math.random() - 0.5) * 4;
                newParams.dimension = 3.0 + Math.random() * 1.5; // 3.0 - 4.5
            } else if (targetSystem === 'Holographic') {
                newParams.geometryType = Math.floor(Math.random() * 8); // 0-7 geometry types
            }
            
            // Apply parameters
            applyUnifiedParameters(newParams, targetSystem);
            
            // Show notification
            showParameterNotification('🎲 Parameters Randomized!', 'Generated new random variation');
        };
        
        // QUICK RANDOMIZE - just visual parameters
        window.quickRandomize = function() {
            const visualParams = {
                density: 0.5 + Math.random() * 2.5,
                speed: 0.1 + Math.random() * 1.9,
                chaos: Math.random(),
                hue: Math.floor(Math.random() * 360),
                saturation: 0.5 + Math.random() * 0.5,
                intensity: 0.3 + Math.random() * 0.7
            };
            
            applyUnifiedParameters(visualParams);
            showParameterNotification('⚡ Quick Randomized!', 'Visual parameters shuffled');
        };
        
        // PARAMETER APPLICATION SYSTEM
        window.applyUnifiedParameters = function(newParams, targetSystem = null) {
            const system = targetSystem || unifiedParameters.systemType;
            
            // Update global state
            Object.assign(unifiedParameters, newParams);
            
            // Apply to UI sliders
            updateAllSliders(newParams, system);
            
            // Apply to active system
            if (system === 'VIB34D' && window.engine) {
                applyToVIB34D(newParams);
            } else if (system === 'Holographic' && window.holographicSystem) {
                applyToHolographic(newParams);
            }
            
            console.log('🔄 Applied unified parameters:', newParams);
        };
        
        // Update all UI sliders
        function updateAllSliders(params, system) {
            // Shared parameters
            const sharedSliders = ['density', 'speed', 'chaos', 'morph', 'hue', 'saturation', 'intensity'];
            
            sharedSliders.forEach(param => {
                if (params[param] !== undefined) {
                    // Update VIB34D sliders
                    const vib34dSlider = document.getElementById(param === 'density' ? 'gridDensity' : param);
                    if (vib34dSlider) {
                        vib34dSlider.value = params[param];
                        // Update display
                        const event = new Event('input');
                        vib34dSlider.dispatchEvent(event);
                    }
                    
                    // Update Holographic sliders
                    const holoSlider = document.getElementById('holo' + param.charAt(0).toUpperCase() + param.slice(1));
                    if (holoSlider) {\n                        holoSlider.value = params[param];\n                        // Update display\n                        const event = new Event('input');\n                        holoSlider.dispatchEvent(event);\n                    }\n                }\n            });\n            \n            // System-specific sliders\n            if (system === 'VIB34D') {\n                ['rot4dXW', 'rot4dYW', 'rot4dZW', 'dimension'].forEach(param => {\n                    if (params[param] !== undefined) {\n                        const slider = document.getElementById(param);\n                        if (slider) {\n                            slider.value = params[param];\n                            const event = new Event('input');\n                            slider.dispatchEvent(event);\n                        }\n                    }\n                });\n                \n                // Update variation\n                if (params.variation !== undefined && window.engine) {\n                    window.engine.switchVariant(params.variation);\n                }\n            }\n        }\n        \n        // Apply parameters to VIB34D system\n        function applyToVIB34D(params) {\n            if (!window.engine) return;\n            \n            if (params.variation !== undefined) {\n                engine.switchVariant(params.variation);\n            }\n            \n            // Apply visual parameters through the engine's parameter system\n            Object.entries(params).forEach(([key, value]) => {\n                if (typeof engine.updateParameter === 'function') {\n                    engine.updateParameter(key, value);\n                }\n            });\n        }\n        \n        // Apply parameters to Holographic system\n        function applyToHolographic(params) {\n            if (!window.holographicSystem) return;\n            \n            if (params.geometryType !== undefined) {\n                holographicSystem.updateVariant(params.geometryType * 4); // Each geometry has 4 variants\n            }\n            \n            // Apply visual parameters\n            Object.entries(params).forEach(([key, value]) => {\n                if (typeof holographicSystem.updateParameter === 'function') {\n                    holographicSystem.updateParameter(key, value);\n                }\n            });\n        }\n        \n        // Parameter notification system\n        function showParameterNotification(title, message) {\n            // Create notification element\n            const notification = document.createElement('div');\n            notification.style.cssText = `\n                position: fixed;\n                top: 80px;\n                right: 20px;\n                background: linear-gradient(145deg, rgba(0, 255, 255, 0.9), rgba(0, 200, 255, 0.8));\n                color: #000;\n                padding: 12px 20px;\n                border-radius: 8px;\n                font-family: 'Orbitron', monospace;\n                font-size: 0.8rem;\n                font-weight: bold;\n                z-index: 10000;\n                box-shadow: 0 4px 20px rgba(0, 255, 255, 0.3);\n                transform: translateX(100%);\n                transition: transform 0.3s ease;\n                max-width: 250px;\n            `;\n            \n            notification.innerHTML = `\n                <div style=\"margin-bottom: 4px;\">${title}</div>\n                <div style=\"font-size: 0.7rem; opacity: 0.8;\">${message}</div>\n            `;\n            \n            document.body.appendChild(notification);\n            \n            // Animate in\n            setTimeout(() => {\n                notification.style.transform = 'translateX(0)';\n            }, 100);\n            \n            // Animate out and remove\n            setTimeout(() => {\n                notification.style.transform = 'translateX(100%)';\n                setTimeout(() => {\n                    if (notification.parentNode) {\n                        notification.parentNode.removeChild(notification);\n                    }\n                }, 300);\n            }, 3000);\n        }\n        \n        // SYSTEM SWITCHING\n        window.switchToSystem = function(systemType) {\n            if (unifiedParameters.systemType === systemType) return;\n            \n            console.log(`🔄 Switching to ${systemType} system`);\n            \n            unifiedParameters.systemType = systemType;\n            \n            // Update active tab\n            if (systemType === 'VIB34D') {\n                switchTab('variations');\n            } else if (systemType === 'Holographic') {\n                switchTab('holograms');\n                // Auto-activate if not already active\n                if (window.activateHolograms && !window.holographicSystem) {\n                    setTimeout(() => {\n                        window.activateHolograms();\n                    }, 100);\n                }\n            }\n            \n            // Apply current parameters to new system\n            applyUnifiedParameters(unifiedParameters, systemType);\n            \n            showParameterNotification(`🔄 Switched to ${systemType}`, 'Parameters synchronized');\n        };\n        \n        // ================================\n        // ENHANCED URL GENERATION\n        // ================================\n        \n        // Fixed generateShareURL with proper parameter encoding\n        window.generateShareURL = function(params) {\n            const baseUrl = window.location.origin + window.location.pathname;\n            const urlParams = new URLSearchParams();\n            \n            // Always set system type\n            urlParams.set('system', params.systemType.toLowerCase());\n            \n            // Shared visual parameters (only if different from defaults)\n            const defaults = {\n                density: 1.5, speed: 0.8, chaos: 0.3, morph: 0.5,\n                hue: 200, saturation: 0.8, intensity: 0.6\n            };\n            \n            Object.entries(defaults).forEach(([key, defaultValue]) => {\n                if (params[key] !== undefined && Math.abs(params[key] - defaultValue) > 0.01) {\n                    urlParams.set(key, params[key].toFixed(3));\n                }\n            });\n            \n            // System-specific parameters\n            if (params.systemType === 'VIB34D') {\n                if (params.variation !== undefined) urlParams.set('variation', params.variation);\n                if (params.rot4dXW !== undefined && Math.abs(params.rot4dXW) > 0.01) urlParams.set('rotXW', params.rot4dXW.toFixed(3));\n                if (params.rot4dYW !== undefined && Math.abs(params.rot4dYW) > 0.01) urlParams.set('rotYW', params.rot4dYW.toFixed(3));\n                if (params.rot4dZW !== undefined && Math.abs(params.rot4dZW) > 0.01) urlParams.set('rotZW', params.rot4dZW.toFixed(3));\n                if (params.dimension !== undefined && Math.abs(params.dimension - 3.5) > 0.01) urlParams.set('dimension', params.dimension.toFixed(3));\n            } else if (params.systemType === 'Holographic') {\n                urlParams.set('holograms', 'true');\n                if (params.geometryType !== undefined) urlParams.set('geometry', params.geometryType);\n            }\n            \n            // Audio setting\n            if (params.audioEnabled) urlParams.set('audio', 'true');\n            \n            return baseUrl + '?' + urlParams.toString();\n        };\n        \n        // ================================\n        // ENHANCED URL PARAMETER LOADING\n        // ================================\n        \n        // Load and apply parameters from URL\n        window.loadParametersFromURL = function(urlParams) {\n            console.log('🔗 Loading parameters from URL...');\n            \n            const params = {};\n            \n            // Determine system type\n            const systemType = urlParams.get('system');\n            if (systemType === 'vib34d') {\n                params.systemType = 'VIB34D';\n            } else if (systemType === 'holograms' || urlParams.get('holograms') === 'true') {\n                params.systemType = 'Holographic';\n            } else {\n                params.systemType = 'VIB34D'; // default\n            }\n            \n            // Load shared visual parameters\n            const visualParams = ['density', 'speed', 'chaos', 'morph', 'hue', 'saturation', 'intensity'];\n            visualParams.forEach(param => {\n                const value = urlParams.get(param);\n                if (value !== null) {\n                    params[param] = parseFloat(value);\n                }\n            });\n            \n            // Load system-specific parameters\n            if (params.systemType === 'VIB34D') {\n                const vib34dParams = ['variation', 'rotXW', 'rotYW', 'rotZW', 'dimension'];\n                vib34dParams.forEach(param => {\n                    const value = urlParams.get(param);\n                    if (value !== null) {\n                        if (param === 'variation') {\n                            params.variation = parseInt(value);\n                        } else if (param.startsWith('rot')) {\n                            params['rot4d' + param.slice(3)] = parseFloat(value);\n                        } else {\n                            params[param] = parseFloat(value);\n                        }\n                    }\n                });\n            } else if (params.systemType === 'Holographic') {\n                const geometry = urlParams.get('geometry');\n                if (geometry !== null) {\n                    params.geometryType = parseInt(geometry);\n                }\n            }\n            \n            // Audio setting\n            if (urlParams.get('audio') === 'true') {\n                params.audioEnabled = true;\n            }\n            \n            // Apply parameters if any were found\n            if (Object.keys(params).length > 1) { // More than just systemType\n                console.log('📥 Applying URL parameters:', params);\n                \n                // Wait for systems to initialize, then apply\n                setTimeout(() => {\n                    applyUnifiedParameters(params, params.systemType);\n                    \n                    // Switch to appropriate system\n                    if (params.systemType === 'Holographic') {\n                        switchToSystem('Holographic');\n                        \n                        // Auto-activate holograms if not already active\n                        if (window.activateHolograms && !window.holographicSystem) {\n                            setTimeout(() => {\n                                window.activateHolograms();\n                            }, 500);\n                        }\n                    }\n                }, 1000);\n            } else {\n                console.log('🔗 No parameters found in URL');\n            }\n        };\n        \n        // ================================\n        // LEGACY COMPATIBILITY FUNCTIONS\n        // ================================\n        \n        // Update slider values when variant changes (enhanced)\n        window.syncHolographicSliders = function() {\n            const params = getCurrentHolographicParameters();\n            if (!params) return;\n            \n            // Apply to unified parameter system\n            applyUnifiedParameters(params, 'Holographic');\n        };
    </script>
</body>
</html>